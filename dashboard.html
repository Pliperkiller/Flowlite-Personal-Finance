<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowlite - Services Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .last-update {
            margin-top: 15px;
            color: #999;
            font-size: 0.9rem;
        }

        .auto-refresh {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .auto-refresh label {
            color: #666;
            cursor: pointer;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .service-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .service-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-title h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .service-icon {
            font-size: 2rem;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-unhealthy {
            background: #f8d7da;
            color: #721c24;
        }

        .status-degraded {
            background: #fff3cd;
            color: #856404;
        }

        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
        }

        .service-url {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .service-url:hover {
            text-decoration: underline;
        }

        .components {
            margin-top: 20px;
        }

        .components h3 {
            color: #555;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .component-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .component-item:hover {
            background: #e9ecef;
        }

        .component-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #333;
        }

        .component-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.healthy {
            background: #28a745;
        }

        .status-dot.unhealthy {
            background: #dc3545;
        }

        .status-dot.warning {
            background: #ffc107;
        }

        .status-dot.unknown {
            background: #6c757d;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            border-left: 4px solid #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .infrastructure-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .infrastructure-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .infra-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .infra-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .infra-item:hover {
            transform: translateY(-3px);
        }

        .infra-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .infra-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .infra-port {
            color: #666;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.9rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .services-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .infra-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Flowlite - Services Dashboard</h1>
            <p>Monitor en tiempo real de todos los servicios y componentes</p>
            <div class="last-update" id="lastUpdate">Cargando...</div>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-refresh cada 10 segundos</label>
                <button class="refresh-btn" onclick="refreshAll()">üîÑ Refrescar Ahora</button>
            </div>
        </div>

        <!-- Infrastructure Services -->
        <div class="infrastructure-section">
            <h2>üèóÔ∏è Servicios de Infraestructura</h2>
            <div class="infra-grid">
                <div class="infra-item">
                    <div class="infra-icon">üóÑÔ∏è</div>
                    <div class="infra-name">MySQL</div>
                    <div class="infra-port">localhost:3306</div>
                </div>
                <div class="infra-item">
                    <div class="infra-icon">‚ö°</div>
                    <div class="infra-name">Redis</div>
                    <div class="infra-port">localhost:6379</div>
                </div>
                <div class="infra-item">
                    <div class="infra-icon">üê∞</div>
                    <div class="infra-name">RabbitMQ</div>
                    <div class="infra-port">localhost:5672</div>
                </div>
                <div class="infra-item">
                    <div class="infra-icon">üéõÔ∏è</div>
                    <div class="infra-name">RabbitMQ UI</div>
                    <div class="infra-port">
                        <a href="http://localhost:15672" target="_blank" style="color: #667eea; text-decoration: none;">localhost:15672</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Application Services -->
        <div class="services-grid" id="servicesGrid">
            <div class="loading">
                <div class="spinner"></div>
                Cargando servicios...
            </div>
        </div>

        <footer>
            <p>Flowlite Personal Finance Platform | Powered by Claude Code</p>
        </footer>
    </div>

    <script>
        const services = [
            {
                name: 'IdentityService',
                icon: 'üîê',
                port: 8000,
                healthUrl: 'http://localhost:8000/actuator/health',
                docsUrl: 'http://localhost:8000/swagger-ui.html',
                components: null // Spring Boot Actuator tiene su propio formato
            },
            {
                name: 'UploadService',
                icon: 'üì§',
                port: 8001,
                healthUrl: 'http://localhost:8001/health',
                docsUrl: 'http://localhost:8001/docs',
                components: null
            },
            {
                name: 'InsightService',
                icon: 'ü§ñ',
                port: 8002,
                healthUrl: 'http://localhost:8002/health/full',
                docsUrl: 'http://localhost:8002/docs',
                components: ['database', 'rabbitmq', 'llm']
            }
        ];

        let autoRefreshInterval = null;

        async function checkServiceHealth(service) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(service.healthUrl, {
                    signal: controller.signal,
                    mode: 'cors'
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    return {
                        status: 'unhealthy',
                        error: `HTTP ${response.status}`,
                        components: null
                    };
                }

                const data = await response.json();

                // Parse response based on service type
                if (service.name === 'IdentityService') {
                    return {
                        status: data.status === 'UP' ? 'healthy' : 'unhealthy',
                        components: data.components || null
                    };
                } else if (service.name === 'InsightService') {
                    return {
                        status: data.status || 'unknown',
                        components: data.components || null
                    };
                } else {
                    return {
                        status: data.status === 'ok' || data.status === 'healthy' ? 'healthy' : 'unhealthy',
                        components: null
                    };
                }

            } catch (error) {
                return {
                    status: 'unhealthy',
                    error: error.name === 'AbortError' ? 'Timeout' : error.message,
                    components: null
                };
            }
        }

        function getStatusBadgeClass(status) {
            if (status === 'healthy' || status === 'UP') return 'status-healthy';
            if (status === 'unhealthy' || status === 'DOWN') return 'status-unhealthy';
            if (status === 'degraded') return 'status-degraded';
            return 'status-loading';
        }

        function getStatusDotClass(status) {
            if (status === 'healthy' || status === 'UP' || status === 'configured') return 'healthy';
            if (status === 'unhealthy' || status === 'DOWN') return 'unhealthy';
            if (status === 'degraded' || status === 'warning') return 'warning';
            return 'unknown';
        }

        function getComponentIcon(componentName) {
            const icons = {
                'database': 'üóÑÔ∏è',
                'db': 'üóÑÔ∏è',
                'rabbitmq': 'üê∞',
                'llm': 'ü§ñ',
                'redis': '‚ö°',
                'diskSpace': 'üíæ',
                'ping': 'üèì'
            };
            return icons[componentName] || '‚öôÔ∏è';
        }

        function renderServiceCard(service, healthData) {
            const statusClass = getStatusBadgeClass(healthData.status);
            const statusText = healthData.status.toUpperCase();

            let componentsHtml = '';

            if (healthData.components && service.components) {
                componentsHtml = `
                    <div class="components">
                        <h3>Componentes</h3>
                        ${service.components.map(compName => {
                            const comp = healthData.components[compName];
                            if (!comp) return '';

                            const status = comp.status || 'unknown';
                            const dotClass = getStatusDotClass(status);
                            const icon = getComponentIcon(compName);

                            return `
                                <div class="component-item">
                                    <div class="component-name">
                                        <span>${icon}</span>
                                        <span>${compName.toUpperCase()}</span>
                                    </div>
                                    <div class="component-status">
                                        <span class="status-dot ${dotClass}"></span>
                                        <span style="font-size: 0.9rem; color: #666;">${status}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // Handle Spring Boot Actuator format for IdentityService
            if (service.name === 'IdentityService' && healthData.components) {
                const springComponents = Object.entries(healthData.components).map(([name, data]) => {
                    const status = data.status || 'unknown';
                    const dotClass = getStatusDotClass(status);
                    const icon = getComponentIcon(name);

                    return `
                        <div class="component-item">
                            <div class="component-name">
                                <span>${icon}</span>
                                <span>${name.toUpperCase()}</span>
                            </div>
                            <div class="component-status">
                                <span class="status-dot ${dotClass}"></span>
                                <span style="font-size: 0.9rem; color: #666;">${status}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                if (springComponents) {
                    componentsHtml = `
                        <div class="components">
                            <h3>Componentes</h3>
                            ${springComponents}
                        </div>
                    `;
                }
            }

            const errorHtml = healthData.error ? `
                <div class="error-message">
                    <strong>Error:</strong> ${healthData.error}
                </div>
            ` : '';

            return `
                <div class="service-card">
                    <div class="service-header">
                        <div class="service-title">
                            <span class="service-icon">${service.icon}</span>
                            <h2>${service.name}</h2>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <a href="http://localhost:${service.port}" target="_blank" class="service-url">
                        http://localhost:${service.port}
                    </a>
                    <a href="${service.docsUrl}" target="_blank" class="service-url">
                        üìö Documentaci√≥n API
                    </a>
                    ${componentsHtml}
                    ${errorHtml}
                </div>
            `;
        }

        async function refreshAll() {
            const grid = document.getElementById('servicesGrid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div>Actualizando...</div>';

            const healthChecks = await Promise.all(
                services.map(service => checkServiceHealth(service))
            );

            const cardsHtml = services.map((service, index) =>
                renderServiceCard(service, healthChecks[index])
            ).join('');

            grid.innerHTML = cardsHtml;

            // Update last update time
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                `√öltima actualizaci√≥n: ${now.toLocaleTimeString()}`;
        }

        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');

            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshAll, 10000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // Event listeners
        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);

        // Initial load
        refreshAll();
        setupAutoRefresh();
    </script>
</body>
</html>
